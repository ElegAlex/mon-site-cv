---
// src/components/Projects.astro — Phase 3 (Portfolio + GitHub stats + Blog feeds)
import { getRepoStats } from '../lib/github';
import { getLatestPosts } from '../lib/rss';
import fallbackPosts from '../data/blog-posts.json';

// Fetch GitHub stats at build time
const orchestrA = await getRepoStats('ElegAlex', 'Orchestr-A');
const opsTracker = await getRepoStats('ElegAlex', 'OPSTRACKER');

// Fetch RSS feeds at build time (with static fallback)
let elegartechPosts = await getLatestPosts('https://www.elegartech.fr/feed/', 3);
if (elegartechPosts.length === 0) elegartechPosts = fallbackPosts.elegartech;

let communsPosts = await getLatestPosts('https://communs-numeriques.fr/feed/', 3);
if (communsPosts.length === 0) communsPosts = fallbackPosts.communsNumeriques;

// Helper: format date
function formatDate(dateStr: string): string {
    try {
        return new Date(dateStr).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
    } catch { return dateStr; }
}

// Helper: language color
function langColor(lang: string | null): string {
    const colors: Record<string, string> = {
        TypeScript: '#3178c6',
        PHP: '#4F5D95',
        JavaScript: '#f1e05a',
        Python: '#3572A5',
    };
    return colors[lang || ''] || '#8b9bb4';
}
---

<section id="projets" class="section portfolio-section">
    <div class="max-w-6xl mx-auto">
        <h2 class="section-heading reveal"><i class="fas fa-rocket"></i> Projets & Publications</h2>
        <p class="section-intro reveal">Applications développées, contributions open source et veille technologique.</p>

        <!-- Featured Project: DepotDoc -->
        <div class="featured-project reveal">
            <span class="featured-badge"><i class="fas fa-star"></i> Projet phare — Production nationale</span>
            <h3>DepotDoc</h3>
            <p>Plateforme de dépôt de documents dématérialisés pour le réseau Assurance Maladie. Homogénéisation back-office, amélioration relation client, conduite du changement d'envergure nationale.</p>
            <div class="featured-metrics">
                <div class="featured-metric">
                    <span class="metric-value">360k</span>
                    <span class="metric-desc">utilisations/an</span>
                </div>
                <div class="featured-metric">
                    <span class="metric-value">30%</span>
                    <span class="metric-desc">adoption réseau national</span>
                </div>
                <div class="featured-metric">
                    <span class="metric-value">-50%</span>
                    <span class="metric-desc">flux papier</span>
                </div>
            </div>
            <div class="featured-stack">
                <span class="skill-tag">Symfony</span>
                <span class="skill-tag">PHP</span>
                <span class="skill-tag">PostgreSQL</span>
            </div>
            <a href="https://www.depotdoc.fr" target="_blank" rel="noopener noreferrer" class="project-link">
                depotdoc.fr <i class="fas fa-external-link-alt"></i>
            </a>
        </div>

        <!-- GitHub Projects Grid -->
        <div class="grid md:grid-cols-2 gap-6 mt-8">

            <!-- Orchestr-A -->
            <div class="github-card reveal">
                <div class="github-card-header">
                    <h3><i class="fab fa-github mr-2" style="color: var(--color-text-muted);"></i>Orchestr-A</h3>
                    <span class="github-card-status status-active">En développement</span>
                </div>
                <p>{orchestrA?.description || "Application de gestion de projets et ressources humaines pour collectivités territoriales."}</p>
                <div class="featured-stack">
                    <span class="skill-tag skill-tag-highlight">NestJS 11</span>
                    <span class="skill-tag skill-tag-highlight">Next.js 16</span>
                    <span class="skill-tag">PostgreSQL</span>
                    <span class="skill-tag">Redis</span>
                    <span class="skill-tag">Turborepo</span>
                </div>
                <div class="github-card-meta">
                    {orchestrA && (
                        <>
                            <span><span class="lang-dot" style={`background: ${langColor(orchestrA.language)}`}></span> {orchestrA.language}</span>
                            <span><i class="fas fa-star"></i> {orchestrA.stargazers_count}</span>
                            <span><i class="fas fa-code-branch"></i> {orchestrA.forks_count}</span>
                            <span><i class="fas fa-clock"></i> {formatDate(orchestrA.pushed_at)}</span>
                        </>
                    )}
                    {!orchestrA && <span style="font-style: italic;">Stats GitHub indisponibles au build</span>}
                </div>
                <div class="github-card-footer">
                    <a href="https://github.com/ElegAlex/Orchestr-A" target="_blank" rel="noopener noreferrer">
                        <i class="fab fa-github"></i> Voir sur GitHub
                    </a>
                </div>
            </div>

            <!-- OPSTRACKER -->
            <div class="github-card reveal">
                <div class="github-card-header">
                    <h3><i class="fab fa-github mr-2" style="color: var(--color-text-muted);"></i>OPSTRACKER</h3>
                    <span class="github-card-status status-production">En production</span>
                </div>
                <p>{opsTracker?.description || "Application de suivi d'opérations IT et monitoring helpdesk."}</p>
                <div class="featured-stack">
                    <span class="skill-tag skill-tag-highlight">Symfony</span>
                    <span class="skill-tag">PHP</span>
                    <span class="skill-tag">PostgreSQL</span>
                    <span class="skill-tag">Redis</span>
                    <span class="skill-tag">Docker</span>
                </div>
                <div class="github-card-meta">
                    {opsTracker && (
                        <>
                            <span><span class="lang-dot" style={`background: ${langColor(opsTracker.language)}`}></span> {opsTracker.language}</span>
                            <span><i class="fas fa-star"></i> {opsTracker.stargazers_count}</span>
                            <span><i class="fas fa-code-branch"></i> {opsTracker.forks_count}</span>
                            <span><i class="fas fa-clock"></i> {formatDate(opsTracker.pushed_at)}</span>
                        </>
                    )}
                    {!opsTracker && <span style="font-style: italic;">Stats GitHub indisponibles au build</span>}
                </div>
                <div class="github-card-footer">
                    <a href="https://github.com/ElegAlex/OPSTRACKER" target="_blank" rel="noopener noreferrer">
                        <i class="fab fa-github"></i> Voir sur GitHub
                    </a>
                </div>
            </div>

        </div>

        <!-- Blog Feeds -->
        <div class="blog-feed-section reveal">
            <h3 class="blog-feed-title"><i class="fas fa-rss"></i> Dernières publications</h3>
            <div class="grid md:grid-cols-2 gap-6">

                <!-- Elegartech -->
                <div class="blog-feed-card">
                    <div class="blog-feed-card-header">
                        <div class="blog-feed-icon"><i class="fas fa-laptop-code"></i></div>
                        <div>
                            <h4>Elegartech.fr</h4>
                            <span>Blog technique — IA, Open Source, Transformation Digitale</span>
                        </div>
                    </div>
                    {elegartechPosts.map((post) => (
                        <div class="blog-post-item">
                            <a href={post.link} target="_blank" rel="noopener noreferrer">{post.title}</a>
                            {post.pubDate && <div class="post-date">{formatDate(post.pubDate)}</div>}
                            {post.contentSnippet && <div class="post-snippet">{post.contentSnippet}</div>}
                        </div>
                    ))}
                </div>

                <!-- Communs Numériques -->
                <div class="blog-feed-card">
                    <div class="blog-feed-card-header">
                        <div class="blog-feed-icon"><i class="fas fa-users-cog"></i></div>
                        <div>
                            <h4>Communs Numériques</h4>
                            <span>Recherche — Communs numériques, Administration</span>
                        </div>
                    </div>
                    {communsPosts.map((post) => (
                        <div class="blog-post-item">
                            <a href={post.link} target="_blank" rel="noopener noreferrer">{post.title}</a>
                            {post.pubDate && <div class="post-date">{formatDate(post.pubDate)}</div>}
                            {post.contentSnippet && <div class="post-snippet">{post.contentSnippet}</div>}
                        </div>
                    ))}
                </div>

            </div>
        </div>

        <!-- Personal Interests -->
        <div class="interests-subsection reveal">
            <h3 class="blog-feed-title"><i class="fas fa-palette"></i> Centres d'intérêt</h3>
            <div class="interests-grid">
                <div class="interest-card">
                    <div class="interest-card-icon"><i class="fas fa-paint-brush"></i></div>
                    <h4>Art Numérique</h4>
                    <p>Création artistique assistée par les nouvelles technologies.</p>
                    <a href="https://www.elegartex.fr" target="_blank" rel="noopener noreferrer" class="interest-link">
                        Elegartex.fr <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
                <div class="interest-card">
                    <div class="interest-card-icon"><i class="fas fa-toolbox"></i></div>
                    <h4>Maroquinerie</h4>
                    <p>Restauration de pièces de maroquinerie anciennes.</p>
                </div>
            </div>
        </div>

    </div>
</section>
